<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Northwestern Carpool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      font-variant-numeric: tabular-nums;
      background:#f6f7fb;
      margin:0;
    }

    header{
      background:#4e2a84;
      color:#fff;
      padding:14px 14px 12px;
      position:sticky;
      top:0;
      z-index:50;
      box-shadow:0 2px 10px rgba(0,0,0,.10);
    }

 
    /* New header layout */
/* ===== Header (Plan A) ===== */
.brandTop{
  max-width:980px;
  margin:0 auto;
  padding:10px 0 8px;
  position:relative; /* for right-top auth */
}

/* Title centered */
.brandTitleRow{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
}

.brandTitleBig{
  margin:0;
  font-size:26px;          /* bigger */
  font-weight:950;
  letter-spacing:.2px;
  text-align:center;
  line-height:1.1;
  white-space:nowrap;
}

/* White paw svg */
.paw{
  width:18px;
  height:18px;
  flex:0 0 auto;
}

/* Tagline: single line, white bg, black text */
.brandSubCenter{
  text-align:center;
  margin-top:10px;
}

.taglinePill{
  display:inline-block;
  background:#fff;
  color:#111;
  padding:7px 12px;
  border-radius:999px;
  font-weight:900;
  font-size:12.5px;
  line-height:1;
  box-shadow:0 2px 8px rgba(0,0,0,.10);
}

/* Right-top auth: small + clean */
.authRow{
  position:absolute;
  top:8px;
  right:0;
  display:flex;
  align-items:center;
  gap:8px;
}

.chip{
  max-width:160px;
  padding:5px 9px;
  border-radius:999px;
  background:rgba(255,255,255,.16);
  border:1px solid rgba(255,255,255,.25);
  font-size:12px;
  font-weight:800;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.authBtn{
  border:none;
  background:rgba(255,255,255,.16);
  color:#fff;
  border:1px solid rgba(255,255,255,.25);
  border-radius:999px;
  padding:6px 9px;
  font-size:12px;
  font-weight:900;
  cursor:pointer;
}

/* Mobile tweaks */
@media (max-width:520px){
  header{ padding:12px 12px 10px; }
  .brandTop{ padding:10px 0 10px; }

  .brandTitleBig{ font-size:22px; }

  /* chip hides on tiny screens to prevent overlap */
  .chip{ display:none; }

  .authRow{ top:6px; right:0; }
  .authBtn{ padding:6px 9px; font-size:12px; }

  .taglinePill{
    font-size:12px;
    padding:7px 10px;
    max-width:92%;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
}

/* Make chip + auth button look clean on mobile */
@media (max-width:520px){
  .brandTitleBig{ font-size:20px; }
  .tabsWrap{ gap:6px; }
  .tabBtn{ font-size:13px; padding:10px 8px; }
  .chip{ max-width:220px; }
}

/* Auth placed near My Rides (above tabs) */
.tabsAuth{
  position:absolute;
  right:0;
  top:-38px;
  display:flex;
  align-items:center;
  gap:8px;
  z-index:60;
}

/* Make sure auth button is not full width */
.authBtn{
  width:auto;
  margin-top:0;
}
.chip{
  width:auto;
}

/* Mobile: hide chip, keep small button */
@media (max-width:520px){
  .tabsAuth{ top:-19.5px; }
  .chip{ display:none; }
}

    /* Tabs */
    .tabsWrap{
      max-width:980px;
      margin:10px auto 0;
      display:flex;
      gap:8px;
      position:relative;
    }
    .tabBtn{
      flex:1;
      border:none;
      border-radius:12px;
      padding:10px 10px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      background:rgba(255,255,255,.14);
      color:#fff;
      border:1px solid rgba(255,255,255,.25);
    }
    .tabBtn.active{
      background:#fff;
      color:#4e2a84;
      border-color:#fff;
    }

    main{
      max-width:980px;
      margin:16px auto 28px;
      padding:0 14px;
    }

    .card{
      background:#fff;
      border-radius:14px;
      padding:16px 14px 14px;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }

    .card-title{
      text-align:center;
      font-weight:950;
      font-size:26px;
      margin:6px 0 14px;
      color:#111;
    }

    label{
      display:block;
      font-size:14px;
      font-weight:850;
      color:#222;
      margin-top:14px;
      text-align:left;
    }

    input, select, textarea, button{
      width:100%;
      padding:12px;
      margin-top:7px;
      border-radius:12px;
      border:1px solid #ddd;
      box-sizing:border-box;
      font-size:16px;
      background:#fff;
    }
input[type="date"]{
  max-width:100%;
  height:48px;
  line-height:24px;
  padding:12px;
}

@supports (-webkit-touch-callout: none){
  input[type="date"]{
    -webkit-appearance:none;
    appearance:none;
  }
}
    button{
      background:#4e2a84;
      color:#fff;
      border:none;
      cursor:pointer;
      font-weight:900;
      margin-top:16px;
      padding:12px;
      border-radius:12px;
    }
    button.secondary{
      background:#ece7f6;
      color:#4e2a84;
      border:1px solid #d9ccef;
    }
    button.danger{
      background:#b91c1c;
    }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .muted{ color:#666; font-size:13px; margin-top:10px; white-space:pre-wrap; }
    .error{ color:#b91c1c; font-size:13px; margin-top:10px; white-space:pre-wrap; }

    .split{ display:flex; gap:12px; }
    .split > *{ flex:1; }

    .hr{ height:1px; background:#eee; margin:16px 0; }

    .ride{
      border:1px solid #eee;
      border-radius:14px;
      padding:12px;
      margin-top:12px;
      background:#fff;
    }
    /* Version G ride card */
.rideTime{
  font-size:18px;
  font-weight:950;
  color:#111;
  margin-top:8px;
  letter-spacing:.1px;
}
.rideMeta{
  font-size:13px;
  font-weight:800;
  color:#555;
  margin-top:6px;
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.rideStatus{
  margin-left:auto;
  padding:4px 10px;
  border-radius:999px;
  background:#f2effa;
  color:#4e2a84;
  font-size:12px;
  font-weight:900;
}
.kv{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.kvRow{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
}
.kvLabel{
  font-size:13px;
  color:#555;
  font-weight:800;
}
.kvValue{
  font-size:14px;
  color:#111;
  font-weight:950;
  text-align:right;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width:65%;
}

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      background:#f2effa;
      color:#4e2a84;
      font-size:12px;
      font-weight:800;
    }

    .leave-big{
      font-size:17px;
      font-weight:900;
      margin-top:10px;
      color:#111;
    }
    .leave-big span{ font-weight:950; }

    .big-row{
      font-size:16px;
      font-weight:900;
      color:#111;
      margin-top:10px;
    }
    .big-row strong{ font-weight:950; }

    .hint{
      color:#666;
      font-size:12px;
      margin-top:6px;
    }

    .hidden{ display:none !important; }

    /* Modal */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      z-index:100;
      padding:18px;
    }
    .overlay.show{ display:flex; align-items:center; justify-content:center; }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      padding:14px;
    }
    .modalTitle{
      font-size:18px;
      font-weight:950;
      margin:4px 0 10px;
      color:#111;
      text-align:center;
    }
    .modalActions{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .modalActions button{ margin-top:0; }
    .modalClose{
      border:none;
      background:transparent;
      font-size:18px;
      cursor:pointer;
      float:right;
      line-height:1;
      padding:6px 8px;
    }
    .textareaBox{
      width:100%;
      min-height:96px;
      resize:vertical;
    }

    /* Slightly tighter on very small screens */
    @media (max-width:420px){
      .brandTitle{ font-size:18px; }
      .tabBtn{ font-size:13px; padding:9px 8px; }
      .card-title{ font-size:24px; }
      input,select,textarea,button{ font-size:15px; }
      .big-row{ font-size:15px; }
    }
    @media (max-width:520px){
  .brandTitleBig{ font-size: clamp(22px, 6.2vw, 30px); }
  .paw{ width: clamp(18px, 5vw, 28px); height: clamp(18px, 5vw, 28px); }
}

  </style>
</head>

<body>
<header>
  <!-- Top brand block -->
<div class="brandTop">

  <!-- Center title -->
  <div class="brandTitleRow">
    <!-- Left white paw -->
    <svg class="paw" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M8.7 9.4c-.9-.7-2.2-.5-2.9.4-.8 1-.6 2.5.5 3.2.9.6 2.1.4 2.8-.5.8-1 .6-2.4-.4-3.1Z" fill="#fff"/>
      <path d="M15.7 9.2c-.9-.7-2.2-.5-2.9.4-.8 1-.6 2.5.5 3.2.9.6 2.1.4 2.8-.5.8-1 .6-2.4-.4-3.1Z" fill="#fff"/>
      <path d="M6.2 13.9c-1.1-.5-2.4 0-2.9 1.1-.6 1.3 0 2.9 1.4 3.4 1.1.4 2.3-.1 2.8-1.3.6-1.3.1-2.7-1.3-3.2Z" fill="#fff"/>
      <path d="M19.4 13.9c-1.1-.5-2.4 0-2.9 1.1-.6 1.3 0 2.9 1.4 3.4 1.1.4 2.3-.1 2.8-1.3.6-1.3.1-2.7-1.3-3.2Z" fill="#fff"/>
      <path d="M12 12.7c-2.6 0-4.7 1.8-4.7 4.1 0 2.5 2.2 4.5 4.7 4.5s4.7-2 4.7-4.5c0-2.3-2.1-4.1-4.7-4.1Z" fill="#fff"/>
    </svg>

    <h1 class="brandTitleBig">Northwestern Carpool</h1>

    <!-- Right white paw -->
    <svg class="paw" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M8.7 9.4c-.9-.7-2.2-.5-2.9.4-.8 1-.6 2.5.5 3.2.9.6 2.1.4 2.8-.5.8-1 .6-2.4-.4-3.1Z" fill="#fff"/>
      <path d="M15.7 9.2c-.9-.7-2.2-.5-2.9.4-.8 1-.6 2.5.5 3.2.9.6 2.1.4 2.8-.5.8-1 .6-2.4-.4-3.1Z" fill="#fff"/>
      <path d="M6.2 13.9c-1.1-.5-2.4 0-2.9 1.1-.6 1.3 0 2.9 1.4 3.4 1.1.4 2.3-.1 2.8-1.3.6-1.3.1-2.7-1.3-3.2Z" fill="#fff"/>
      <path d="M19.4 13.9c-1.1-.5-2.4 0-2.9 1.1-.6 1.3 0 2.9 1.4 3.4 1.1.4 2.3-.1 2.8-1.3.6-1.3.1-2.7-1.3-3.2Z" fill="#fff"/>
      <path d="M12 12.7c-2.6 0-4.7 1.8-4.7 4.1 0 2.5 2.2 4.5 4.7 4.5s4.7-2 4.7-4.5c0-2.3-2.1-4.1-4.7-4.1Z" fill="#fff"/>
    </svg>
  </div>

  <!-- Single-line tagline pill -->
  <div class="brandSubCenter">
    <span class="taglinePill">Find a ride-mate. Split your airport Uber.</span>
  </div>
</div>


  <!-- Tabs: Find, Post, My -->
  <div class="tabsWrap">
  <div class="tabsAuth">
    <div id="auth_chip" class="chip hidden"></div>
    <button id="auth_btn" class="authBtn">Sign in</button>
  </div>

  <button class="tabBtn active" id="tab_find">Find a Ride</button>
  <button class="tabBtn" id="tab_post">Post a Ride</button>
  <button class="tabBtn" id="tab_my">My Rides</button>
</div>


</header>


<main>
  <!-- POST -->
  <section id="view_post" class="card hidden">

    <div class="card-title">Post a Ride</div>

    <label for="post_direction">Direction</label>
    <select id="post_direction">
      <option value="Evanston → Airport" selected>Evanston → Airport</option>
      <option value="Airport → Evanston">Airport → Evanston</option>
    </select>

    <label for="post_airport">Airport</label>
    <select id="post_airport">
      <option value="ORD" selected>ORD</option>
      <option value="MDW">MDW</option>
    </select>

    <label for="post_date">Date</label>
    <input id="post_date" type="date" />
    <div class="hint" id="post_date_display"></div>

    <label>Leave window</label>
    <div class="split">
      <div>
        <label for="post_from" style="margin-top:0;">From (earliest)</label>
        <select id="post_from"></select>
      </div>
      <div>
        <label for="post_to" style="margin-top:0;">To (latest)</label>
        <select id="post_to"></select>
      </div>
    </div>

    <label for="post_max_seats">Max seats (including you)</label>
    <select id="post_max_seats">
      <option value="2">2</option>
      <option value="3" selected>3</option>
    </select>

    <label for="post_contact">Contact</label>
    <input id="post_contact" placeholder="Enter your contact info" />

    <button id="post_btn">Submit Ride</button>
    <div id="post_msg" class="muted"></div>
    <div id="post_err" class="error"></div>
  </section>

  <!-- FIND -->
 <section id="view_find" class="card">

    <div class="card-title">Find a Ride</div>

    <label for="find_direction">Direction</label>
    <select id="find_direction">
      <option value="Evanston → Airport" selected>Evanston → Airport</option>
      <option value="Airport → Evanston">Airport → Evanston</option>
    </select>

    <label for="find_airport">Airport</label>
    <select id="find_airport">
      <option value="ORD" selected>ORD</option>
      <option value="MDW">MDW</option>
    </select>

    <label for="find_date">Date</label>
    <input id="find_date" type="date" />
    <div class="hint" id="find_date_display"></div>

    <label for="find_time">Leave around (optional)</label>
    <select id="find_time"></select>
    <div class="hint">If you pick a time, we’ll sort rides closest to that time. Otherwise, we’ll show all rides for the day.</div>

    <button id="find_btn" class="secondary">Search</button>
    <div id="find_msg" class="muted"></div>
    <div id="find_err" class="error"></div>

    <div id="results"></div>
  </section>

  <!-- MY -->
  <section id="view_my" class="card hidden">
    <div class="card-title">My Rides</div>
    <div class="muted" style="margin-top:6px;">Sign in to see rides you posted or joined.</div>

    <button id="my_refresh_btn" class="secondary">Refresh</button>
    <div id="my_msg" class="muted"></div>
    <div id="my_err" class="error"></div>

    <div class="hr"></div>

    <div id="my_rides"></div>
  </section>
</main>

<!-- SIGN IN MODAL -->
<div id="signin_overlay" class="overlay">
  <div class="modal">
    <button class="modalClose" id="signin_close">✕</button>

    <div class="modalTitle" id="signin_title">Sign in</div>

    <!-- SIGN IN VIEW -->
    <div id="signin_view">
      <label for="signin_email" style="margin-top:8px;">NU Email</label>
      <input id="signin_email" placeholder="name@u.northwestern.edu" />

      <label for="signin_password" style="margin-top:10px;">Password</label>
      <input id="signin_password" type="password" placeholder="At least 8 characters" />

      <!-- Big primary sign in button -->
      <button id="signin_pw_btn" type="button">Sign in</button>

      <!-- bottom row: forgot left, signup right -->
      <div class="modalActions" style="margin-top:10px;">
        <button id="forgot_pw_btn" class="secondary" type="button">Forgot password</button>
        <button id="signup_pw_btn" class="secondary" type="button">Sign up</button>
      </div>

      <div id="signin_msg" class="muted"></div>
      <div id="signin_err" class="error"></div>
    </div>

    <!-- RESET PASSWORD VIEW (hidden by default) -->
    <div id="reset_view" class="hidden">
      <div class="hint" style="margin-top:6px;">
        Set a new password for your account.
      </div>

      <label for="reset_pw1" style="margin-top:10px;">New password</label>
      <input id="reset_pw1" type="password" placeholder="At least 8 characters" />

      <label for="reset_pw2" style="margin-top:10px;">Confirm new password</label>
      <input id="reset_pw2" type="password" placeholder="Type it again" />

      <button id="reset_save_btn" type="button">Update password</button>
      <button id="reset_back_btn" class="secondary" type="button">Back to sign in</button>

      <div id="reset_msg" class="muted"></div>
      <div id="reset_err" class="error"></div>
    </div>
  </div>
</div>

<!-- SIGN UP MODAL -->
<div id="signup_overlay" class="overlay">
  <div class="modal">
    <button class="modalClose" id="signup_close">✕</button>

    <div class="modalTitle">Create account</div>

    <label for="signup_email" style="margin-top:8px;">NU Email</label>
    <input id="signup_email" placeholder="name@u.northwestern.edu" />

    <label for="signup_password" style="margin-top:10px;">Password</label>
    <input id="signup_password" type="password" placeholder="At least 8 characters" />

    <label for="signup_password2" style="margin-top:10px;">Confirm password</label>
    <input id="signup_password2" type="password" placeholder="Type it again" />

    <div class="modalActions">
      <button id="signup_create_btn" type="button">Create account</button>
      <button id="signup_back_btn" class="secondary" type="button">Back</button>
    </div>

    <div id="signup_msg" class="muted"></div>
    <div id="signup_err" class="error"></div>
  </div>
</div>

  
<!-- JOIN CONFIRMATION MODAL -->
<div id="join_overlay" class="overlay">
  <div class="modal">
    <button class="modalClose" id="join_close">✕</button>
    <div class="modalTitle" id="join_title">You’ve joined!</div>

    <div id="join_summary" class="muted"></div>

    <label style="margin-top:10px;">Contact</label>
    <input id="join_contact" readonly />

    <div class="modalActions">
      <button id="copy_contact_btn" class="secondary">Copy contact</button>
      <button id="go_my_btn">Go to My Rides</button>
    </div>

    <label style="margin-top:14px;">Message template</label>
    <textarea id="join_message" class="textareaBox"></textarea>

    <div class="modalActions">
      <button id="copy_message_btn" class="secondary">Copy message</button>
      <button id="close_join_btn">Done</button>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const SUPABASE_URL = "https://ylpgfkmjqzuwmqqhubyq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlscGdma21qcXp1d21xcWh1YnlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNjAwMzUsImV4cCI6MjA4NTczNjAzNX0.QuUF6VQdiFf4idaKsV_wCihaOX3QSeT_U1DZ-w1SgkA";
  const sb = window.__nu_carpool_sb || (window.__nu_carpool_sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY));

  // ====== HELPERS ======
  const $ = (id) => document.getElementById(id);
  const setText = (id, t) => { const el=$(id); if(el) el.textContent = t||""; };
  const normEmail = (e) => (e||"").trim().toLowerCase();
  const isNU = (e) => e.endsWith("@u.northwestern.edu");

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function timeToMinutes(t){ const [h,m] = t.split(":").map(Number); return h*60 + m; }
  function windowMidMinutes(from_t, to_t){ return Math.round((timeToMinutes(from_t) + timeToMinutes(to_t))/2); }

  function isoToMDY(iso){
    if(!iso) return "";
    const [y,m,d] = iso.split("-");
    return `${m}/${d}/${y}`;
  }

  function formatTimeAMPM(hhmm){
    if(!hhmm) return "";
    const [hStr, mStr] = hhmm.split(":");
    let h = parseInt(hStr,10);
    const ampm = h >= 12 ? "PM" : "AM";
    h = h % 12; if(h === 0) h = 12;
    return `${h}:${mStr} ${ampm}`;
  }

  function buildTimeOptions(selectEl, defaultHHMM, includeAny=false){
    selectEl.innerHTML = "";
    if(includeAny){
      const anyOpt = document.createElement("option");
      anyOpt.value = "";
      anyOpt.textContent = "Anytime";
      selectEl.appendChild(anyOpt);
    }
    for(let mins = 0; mins < 24*60; mins += 15){
      const hh = String(Math.floor(mins/60)).padStart(2,"0");
      const mm = String(mins%60).padStart(2,"0");
      const hhmm = `${hh}:${mm}`;
      const opt = document.createElement("option");
      opt.value = hhmm;
      opt.textContent = formatTimeAMPM(hhmm);
      selectEl.appendChild(opt);
    }
    if(defaultHHMM !== undefined && defaultHHMM !== null) selectEl.value = defaultHHMM;
  }

  async function copyText(txt){
    try{
      await navigator.clipboard.writeText(txt);
      return true;
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      return true;
    }
  }

  function show(el){ el.classList.remove("hidden"); }
  function hide(el){ el.classList.add("hidden"); }

  // ====== TABS ======
  function activateTab(which){
    const tabs = { post: $("tab_post"), find: $("tab_find"), my: $("tab_my") };
    const views = { post: $("view_post"), find: $("view_find"), my: $("view_my") };

    for(const k of Object.keys(tabs)){
      tabs[k].classList.toggle("active", k===which);
      views[k].classList.toggle("hidden", k!==which);
    }
  }

  // ====== AUTH ======

  function showResetView(){
  hide($("signin_view"));
  show($("reset_view"));
  setText("reset_msg","");
  setText("reset_err","");
  $("reset_pw1").value = "";
  $("reset_pw2").value = "";
}

function showSignInView(){
  show($("signin_view"));
  hide($("reset_view"));
  setText("signin_msg","");
  setText("signin_err","");
}
async function sendPasswordRecovery(email){
  setText("signin_err","");
  setText("signin_msg","Sending recovery email...");
  $("forgot_pw_btn").disabled = true;
  $("signin_pw_btn").disabled = true;
  $("signup_pw_btn").disabled = true;

  try{
    if(!email || !isNU(email)){
      throw new Error("Please enter a Northwestern email (@u.northwestern.edu).");
    }

const redirectTo = window.location.origin + "/";

    const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
    if(error) throw error;

    setText("signin_msg","Recovery email sent. Check your inbox, then come back here.");
    return true;
  }catch(err){
    setText("signin_msg","");
    setText("signin_err", err.message || "Failed to send recovery email.");
    return false;
  }finally{
    $("forgot_pw_btn").disabled = false;
    $("signin_pw_btn").disabled = false;
    $("signup_pw_btn").disabled = false;
  }
}
async function updatePasswordFromRecovery(){
  setText("reset_err","");
  setText("reset_msg","Updating password...");
  $("reset_save_btn").disabled = true;
  $("reset_back_btn").disabled = true;

  try{
    const p1 = $("reset_pw1").value || "";
    const p2 = $("reset_pw2").value || "";

    if(p1.length < 8) throw new Error("Password must be at least 8 characters.");
    if(p1 !== p2) throw new Error("Passwords do not match.");

    const { error } = await sb.auth.updateUser({ password: p1 });
    if(error) throw error;

    setText("reset_msg","Password updated. Please sign in again.");
setText("signin_msg","Password updated. Please sign in.");
showSignInView();

    return true;
  }catch(err){
    setText("reset_msg","");
    setText("reset_err", err.message || "Failed to update password.");
    return false;
  }finally{
    $("reset_save_btn").disabled = false;
    $("reset_back_btn").disabled = false;
  }
}

function resetUIAfterSignOut(){
  // Close any modals
  closeSignInModal();
  closeJoinModal();

  // Clear pending actions
  clearPendingAction();

  // Clear messages and lists
  setText("post_msg","");
  setText("post_err","");
  setText("find_msg","");
  setText("find_err","");
  setText("my_msg","");
  setText("my_err","Signed out.");
  $("my_rides").innerHTML = "";

  // Re-enable buttons
  $("post_btn").disabled = false;
  $("find_btn").disabled = false;
  $("my_refresh_btn").disabled = false;

  // Go back to a safe tab
  activateTab("find");
}

  
  let currentUser = null; // { email, id }
  const PENDING_KEY = "nu_carpool_pending_action";

  function setAuthUI(){
    const chip = $("auth_chip");
    const btn = $("auth_btn");

    if(currentUser?.email){
      chip.textContent = currentUser.email;
      chip.classList.remove("hidden");
      btn.textContent = "Sign out";
    }else{
      chip.classList.add("hidden");
      btn.textContent = "Sign in";
    }
  }

  function openSignInModal(prefillEmail=""){
    setText("signin_msg","");
    setText("signin_err","");
    if(prefillEmail) $("signin_email").value = prefillEmail;
    $("signin_overlay").classList.add("show");
  }

  function closeSignInModal(){
    $("signin_overlay").classList.remove("show");
  }
  
function openSignUpModal(prefillEmail=""){
  setText("signup_msg","");
  setText("signup_err","");
  if(prefillEmail) $("signup_email").value = prefillEmail;
  $("signup_password").value = "";
  $("signup_password2").value = "";
  $("signup_overlay").classList.add("show");
}

function closeSignUpModal(){
  $("signup_overlay").classList.remove("show");
}

async function signUpWithPassword(email, password){
  setText("signin_err","");
  setText("signin_msg","Creating account...");
  $("signup_pw_btn").disabled = true;
  $("signin_pw_btn").disabled = true;

  try{
    if(!email || !isNU(email)){
      throw new Error("Please use your Northwestern email (@u.northwestern.edu).");
    }
    if(!password || password.length < 8){
      throw new Error("Password must be at least 8 characters.");
    }

    const redirectTo = window.location.origin;

    const { error } = await sb.auth.signUp({
      email,
      password,
      options: { emailRedirectTo: redirectTo }
    });

    if(error) throw error;

    setText("signin_msg","Account created. Now sign in with your password.");
    return true;
  }catch(err){
    setText("signin_msg","");
    setText("signin_err", err.message || "Sign up failed.");
    return false;
  }finally{
    $("signup_pw_btn").disabled = false;
    $("signin_pw_btn").disabled = false;
  }
}
async function signInWithPassword(email, password){
  setText("signin_err","");
  setText("signin_msg","Signing in...");
  $("signin_pw_btn").disabled = true;
  $("forgot_pw_btn").disabled = true;
  $("signup_pw_btn").disabled = true;

  try{
    if(!email || !isNU(email)){
      throw new Error("Please use your Northwestern email (@u.northwestern.edu).");
    }
    if(!password){
      throw new Error("Please enter your password.");
    }

    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error) throw error;

    setText("signin_msg","Signed in.");
    return true;
  }catch(err){
    setText("signin_msg","");
    setText("signin_err", err.message || "Sign in failed.");
    return false;
  }finally{
    $("signin_pw_btn").disabled = false;
    $("forgot_pw_btn").disabled = false;
    $("signup_pw_btn").disabled = false;
  }
}



  async function refreshUser(){
  const timeout = (ms) => new Promise((_, rej) => setTimeout(() => rej(new Error("getUser timeout")), ms));

  try{
    const { data } = await Promise.race([
      sb.auth.getUser(),
      timeout(4000),
    ]);

    currentUser = data?.user ? { email: data.user.email, id: data.user.id } : null;
  }catch(err){
    console.warn("refreshUser failed:", err);
    currentUser = null;
  }

  setAuthUI();
  return currentUser;
}


  function savePendingAction(action){
    localStorage.setItem(PENDING_KEY, JSON.stringify({ ...action, ts: Date.now() }));
  }
  function loadPendingAction(){
    try{
      const raw = localStorage.getItem(PENDING_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  }
  function clearPendingAction(){
    localStorage.removeItem(PENDING_KEY);
  }

  async function requireAuthOrQueue(action){
    await refreshUser();
    if(currentUser?.email) return true;

    // queue action then open sign in
    savePendingAction(action);
    openSignInModal(action?.emailHint || "");
    return false;
  }

  async function maybeResumePendingAction(){
    await refreshUser();
    if(!currentUser?.email) return;

    const pending = loadPendingAction();
    if(!pending) return;

    // avoid super old actions
    if(pending.ts && (Date.now() - pending.ts) > 15 * 60 * 1000){
      clearPendingAction();
      return;
    }

    clearPendingAction();
    // resume
    if(pending.type === "POST"){
      await doPostRide(pending.payload);
    }else if(pending.type === "JOIN"){
      await doJoinRide(pending.payload.rideId, null, true);
    }else if(pending.type === "CANCEL"){
      await doCancelJoin(pending.payload.rideId, null, true);
    }else if(pending.type === "LOAD_MY"){
      activateTab("my");
      await loadMyRides();
    }
  }

  // ====== DATA OPS ======
  async function getSeatsFilledMap(rideIds){
    let countsMap = {};
    if(!rideIds.length) return countsMap;
    const { data: parts, error } = await sb.from("ride_participants").select("ride_id").in("ride_id", rideIds);
    if(error) return countsMap;
    for(const p of (parts||[])) countsMap[p.ride_id] = (countsMap[p.ride_id]||0) + 1;
    return countsMap;
  }

  async function getMyJoinedIds(email){
    const { data: joins, error } = await sb.from("ride_participants").select("ride_id").eq("user_email", email);
    if(error) return [];
    return [...new Set((joins||[]).map(j=>j.ride_id))];
  }

  // ====== POST ======
  async function postRideClick(){
    setText("post_err","");
    setText("post_msg","");

    const payload = collectPostPayload();
    if(!payload) return;

    const ok = await requireAuthOrQueue({ type:"POST", payload, emailHint: payload.owner_email });
    if(!ok) return;

    await doPostRide(payload);
  }

  function collectPostPayload(){
    const direction = $("post_direction").value;
    const airport = $("post_airport").value;
    const ride_date_iso = $("post_date").value;
    const from_time = $("post_from").value;
    const to_time = $("post_to").value;
    const max_seats = parseInt($("post_max_seats").value,10);
    const contact = $("post_contact").value.trim();

    const owner_email = normEmail(currentUser?.email || ""); // once signed in
    if(!ride_date_iso){ setText("post_err","Please select a date."); return null; }
    if(!from_time || !to_time){ setText("post_err","Please fill both From and To times."); return null; }
    if(timeToMinutes(from_time) > timeToMinutes(to_time)){ setText("post_err","From time must be earlier than To time."); return null; }
    if(!contact){ setText("post_err","Please provide contact info."); return null; }

    return {
      owner_email, direction, airport,
      ride_date: ride_date_iso,
      from_time, to_time,
      max_seats,
      status: "open",
      note: null,
      contact
    };
  }

  async function doPostRide(payload){
    setText("post_err","");
    setText("post_msg","Posting...");
    $("post_btn").disabled = true;

    // Ensure email now that we're signed in
    await refreshUser();
    payload.owner_email = normEmail(currentUser?.email || "");
    if(!payload.owner_email || !isNU(payload.owner_email)){
      setText("post_msg","");
      setText("post_err","Please sign in with your Northwestern email.");
      $("post_btn").disabled = false;
      return;
    }

    const { data, error } = await sb.from("rides").insert([payload]).select().single();
    if(error){
      setText("post_msg","");
      setText("post_err","Submit failed:\n" + (error.message || JSON.stringify(error)));
      $("post_btn").disabled = false;
      return;
    }

    // owner takes first seat
    await sb.from("ride_participants").insert([{ ride_id: data.id, user_email: payload.owner_email }]);

    setText("post_msg","Posted! Your ride is now open.");
    $("post_btn").disabled = false;

    // Optionally refresh find results if user is on find tab
  }

  // ====== FIND ======
  async function searchRides(){
    setText("find_err","");
    setText("find_msg","Searching...");
    $("find_btn").disabled = true;

    const direction = $("find_direction").value;
    const airport = $("find_airport").value;
    const ride_date_iso = $("find_date").value;
    const t = $("find_time").value; // optional, may be ""

    if(!ride_date_iso){
      setText("find_msg","");
      setText("find_err","Please select a date.");
      $("find_btn").disabled = false;
      return;
    }

    // Show all rides for day (open + full so user can see, but can only join open if seats available)
   // If signed in, hide rides that I posted myself
await refreshUser();
const myEmail = normEmail(currentUser?.email || "");

let q = sb.from("rides")
  .select("*")
  .eq("ride_date", ride_date_iso)
  .eq("direction", direction)
  .eq("airport", airport)
  .in("status", ["open","full"]);

if(myEmail){
  q = q.neq("owner_email", myEmail);
}


    const { data: rides, error } = await q.order("created_at", { ascending:false });
    if(error){
      setText("find_msg","");
      setText("find_err","Search failed:\n" + (error.message || JSON.stringify(error)));
      $("find_btn").disabled = false;
      return;
    }

    const list = rides || [];
    const rideIds = list.map(r=>r.id);
    const countsMap = await getSeatsFilledMap(rideIds);

const myJoined = myEmail ? await getMyJoinedIds(myEmail) : [];


    const tMin = t ? timeToMinutes(t) : null;

    const enriched = list.map(r=>{
      const filled = countsMap[r.id] || 0;
      const mid = windowMidMinutes(r.from_time, r.to_time);
      const dist = (tMin===null) ? null : Math.abs(mid - tMin);
      const alreadyJoined = myJoined.includes(r.id);
      const isOwner = myEmail && normEmail(r.owner_email) === myEmail;
      return { ...r, seats_filled: filled, dist, alreadyJoined, isOwner };
    });

    // Sorting: if time chosen, sort by distance, else sort by earliest from_time
    enriched.sort((a,b)=>{
      if(tMin!==null){
        return (a.dist ?? 0) - (b.dist ?? 0);
      }
      // default: earliest start
      return timeToMinutes(a.from_time) - timeToMinutes(b.from_time);
    });

    renderResults(enriched);
    setText("find_msg", enriched.length ? `Found ${enriched.length} ride(s).` : "No rides for this day.");
    $("find_btn").disabled = false;
  }

  function renderResults(rides){
    const container = $("results");
    container.innerHTML = "";

for(const r of rides){
  const filled = r.seats_filled || 0;
  const max = r.max_seats;
  const isFull = filled >= max;
  const joined = !!r.alreadyJoined;

      const div = document.createElement("div");
      div.className = "ride";

      const joinBtnHtml = joined
        ? `<button data-cancel="${r.id}" class="danger">Cancel Join</button>`
        : `<button data-join="${r.id}" ${isFull ? "disabled" : ""}>Join Ride</button>`;

      const ownerNote = r.isOwner ? `<span class="pill">YOUR POST</span>` : "";

const timeLine = `${formatTimeAMPM(r.from_time)}–${formatTimeAMPM(r.to_time)}`;
const metaLine = `${isoToMDY(r.ride_date)} · ${r.direction} · ${r.airport}`;
const statusText = isFull ? "FULL" : "OPEN";
  
div.innerHTML = `
  <div class="rideTime">${escapeHtml(timeLine)}</div>

  <div class="rideMeta">
    <span>${escapeHtml(metaLine)}</span>
    <span class="rideStatus">${statusText}</span>
  </div>

  <div class="kv">
    <div class="kvRow">
      <div class="kvLabel">Seats</div>
      <div class="kvValue">${filled}/${max} filled</div>
    </div>

    <div class="kvRow">
      <div class="kvLabel">Contact</div>
      <div class="kvValue">${escapeHtml(r.contact)}</div>
    </div>
  </div>

  <div class="row" style="margin-top:12px;">
    ${joinBtnHtml}
  </div>
`;

      container.appendChild(div);
    }

    container.querySelectorAll("button[data-join]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const rideId = btn.getAttribute("data-join");
        await joinRideClick(rideId, btn);
      });
    });

    container.querySelectorAll("button[data-cancel]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const rideId = btn.getAttribute("data-cancel");
        await cancelJoinClick(rideId, btn);
      });
    });
  }

  // ====== JOIN / CANCEL ======

    async function cancelRideAsHostClick(rideId, btn){
    const ok = await requireAuthOrQueue({ type:"CANCEL_RIDE", payload:{ rideId } });
    if(!ok) return;

    await doCancelRideAsHost(rideId, btn, false);
  }

  async function doCancelRideAsHost(rideId, btn, fromResume){
    await refreshUser();
    const email = normEmail(currentUser?.email || "");
    if(!email || !isNU(email)){
      alert("Please sign in with your Northwestern email.");
      return;
    }

    if(!confirm("Cancel (delete) this ride for everyone? This cannot be undone.")) return;

    if(btn){
      btn.disabled = true;
      btn.textContent = "Cancelling...";
    }

    // 1) Make sure this user is the owner
    const { data: ride, error: e0 } = await sb
      .from("rides")
      .select("id, owner_email, max_seats, status")
      .eq("id", rideId)
      .single();

    if(e0 || !ride){
      alert(e0?.message || "Failed to load ride.");
      if(btn){
        btn.disabled = false;
        btn.textContent = "Cancel Ride";
      }
      return;
    }

    if(normEmail(ride.owner_email) !== email){
      alert("You can only cancel rides you posted.");
      if(btn){
        btn.disabled = false;
        btn.textContent = "Cancel Ride";
      }
      return;
    }

  // 2) Delete participants first (so FK constraints won't block the ride delete)
  const { error: pErr } = await sb
    .from("ride_participants")
    .delete()
    .eq("ride_id", rideId);

  if(pErr){
    alert(pErr.message || "Cancel failed (participants).");
    if(btn){
      btn.disabled = false;
      btn.textContent = "Cancel Ride";
    }
    return;
  }

  // 3) Delete the ride itself (this hides it from everyone)
  const { error: rErr } = await sb
    .from("rides")
    .delete()
    .eq("id", rideId);

  if(rErr){
    alert(rErr.message || "Cancel failed (ride).");
    if(btn){
      btn.disabled = false;
      btn.textContent = "Cancel Ride";
    }
    return;
  }


    // 4) Refresh UI
    if(!$("view_my").classList.contains("hidden")){
      await loadMyRides();
    }
    if(!$("view_find").classList.contains("hidden")){
      await searchRides().catch(()=>{});
    }
  }

  async function joinRideClick(rideId, btn){
    // require sign-in (Level 3)
    const ok = await requireAuthOrQueue({ type:"JOIN", payload:{ rideId } });
    if(!ok) return;

    await doJoinRide(rideId, btn, false);
  }

  async function doJoinRide(rideId, btn, fromResume){
    await refreshUser();
    const email = normEmail(currentUser?.email || "");
    if(!email || !isNU(email)){
      alert("Please sign in with your Northwestern email.");
      return;
    }

    if(btn){
      btn.disabled = true;
      btn.textContent = "Joining...";
    }

   
    // Prevent duplicate join (client-side quick check)
    const { data: existing } = await sb
      .from("ride_participants")
      .select("id")
      .eq("ride_id", rideId)
      .eq("user_email", email)
      .maybeSingle();

    if(existing){
      // already joined
      if(btn){
        btn.disabled = false;
        btn.textContent = "Cancel Join";
      }
      await searchRides();
      showJoinModalAfterJoin(rideId, email, true);
      return;
    }

    const { error: e1 } = await sb.from("ride_participants").insert([{ ride_id: rideId, user_email: email }]);
    if(e1){
      alert(e1.message || "Join failed.");
      if(btn){
        btn.disabled = false;
        btn.textContent = "Join Ride";
      }
      return;
    }

    // Update ride status if full
    const { data: ride } = await sb.from("rides").select("*").eq("id", rideId).single();
    const { data: parts } = await sb.from("ride_participants").select("ride_id").eq("ride_id", rideId);
    const filled = (parts||[]).length;

    if(ride && filled >= ride.max_seats){
      await sb.from("rides").update({ status: "full" }).eq("id", rideId);
    }else{
      // ensure open
      await sb.from("rides").update({ status: "open" }).eq("id", rideId);
    }

    // refresh UI + modal
    await searchRides();
    showJoinModal(ride, filled, email);

    // auto switch to My Rides? (You asked for Go to My Rides button; we’ll keep user in Find unless they tap.)
    // If you want auto-switch, tell me and I’ll change it.
  }

  async function cancelJoinClick(rideId, btn){
    const ok = await requireAuthOrQueue({ type:"CANCEL", payload:{ rideId } });
    if(!ok) return;

    await doCancelJoin(rideId, btn, false);
  }

  async function doCancelJoin(rideId, btn, fromResume){
    await refreshUser();
    const email = normEmail(currentUser?.email || "");
    if(!email || !isNU(email)){
      alert("Please sign in with your Northwestern email.");
      return;
    }

    if(!confirm("Cancel your join for this ride?")) return;

    if(btn){
      btn.disabled = true;
      btn.textContent = "Cancelling...";
    }

    const { error } = await sb
      .from("ride_participants")
      .delete()
      .eq("ride_id", rideId)
      .eq("user_email", email);

    if(error){
      alert(error.message || "Cancel failed.");
      if(btn){
        btn.disabled = false;
        btn.textContent = "Cancel Join";
      }
      return;
    }

    // If ride was full, may become open again
    const { data: ride } = await sb.from("rides").select("max_seats,status").eq("id", rideId).single();
    const { data: parts } = await sb.from("ride_participants").select("ride_id").eq("ride_id", rideId);
    const filled = (parts||[]).length;

    if(ride && filled < ride.max_seats){
      await sb.from("rides").update({ status: "open" }).eq("id", rideId);
    }

    // Refresh current views
    // If on Find tab and there are results, refresh search
    await searchRides().catch(()=>{});
    // If on My tab, refresh too
    if(!$("view_my").classList.contains("hidden")){
      await loadMyRides();
    }
  }

  // ====== JOIN MODAL ======
  function openJoinModal(){
    $("join_overlay").classList.add("show");
  }
  function closeJoinModal(){
    $("join_overlay").classList.remove("show");
  }

  function makeMessageTemplate(ride, myEmail){
    const dateStr = isoToMDY(ride.ride_date);
    const windowStr = `${formatTimeAMPM(ride.from_time)}–${formatTimeAMPM(ride.to_time)}`;
    const dir = ride.direction;
    const airport = ride.airport;

    return `Hi! I just joined your carpool on ${dateStr} (${dir}, ${airport}). My leave window is ${windowStr}. Where should we meet, and what time should we confirm? Thanks!`;
  }

  function showJoinModal(ride, filled, myEmail){
    if(!ride) return;
    setText("join_title","You’ve joined!");
    setText("join_summary", `Ride saved to My Rides.\nSeats now: ${filled}/${ride.max_seats}\nDate: ${isoToMDY(ride.ride_date)}\nWindow: ${formatTimeAMPM(ride.from_time)} – ${formatTimeAMPM(ride.to_time)}`);
    $("join_contact").value = ride.contact || "";
    $("join_message").value = makeMessageTemplate(ride, myEmail);
    openJoinModal();
  }

  async function showJoinModalAfterJoin(rideId, myEmail, already){
    const { data: ride } = await sb.from("rides").select("*").eq("id", rideId).single();
    const { data: parts } = await sb.from("ride_participants").select("ride_id").eq("ride_id", rideId);
    const filled = (parts||[]).length;
    showJoinModal(ride, filled, myEmail);
  }

  // ====== MY RIDES ======
  async function loadMyRidesClick(){
    const ok = await requireAuthOrQueue({ type:"LOAD_MY", payload:{} });
    if(!ok) return;

    activateTab("my");
    await loadMyRides();
  }

  async function loadMyRides(){
    setText("my_err","");
    setText("my_msg","Loading...");
    $("my_refresh_btn").disabled = true;

    await refreshUser();
    const email = normEmail(currentUser?.email || "");
    if(!email || !isNU(email)){
      setText("my_msg","");
      setText("my_err","Please sign in with your Northwestern email.");
      $("my_refresh_btn").disabled = false;
      return;
    }

    const { data: posted, error: e1 } = await sb.from("rides")
      .select("*")
      .eq("owner_email", email)
      .order("created_at", { ascending:false });

    if(e1){
      setText("my_msg","");
      setText("my_err", e1.message || "Failed to load posted rides.");
      $("my_refresh_btn").disabled = false;
      return;
    }

    const joinedIds = await getMyJoinedIds(email);
    let joined = [];
    if(joinedIds.length){
      const { data: jr, error: e2 } = await sb.from("rides")
        .select("*")
        .in("id", joinedIds)
        .order("created_at", { ascending:false });
      if(!e2) joined = jr || [];
    }

    const allIds = [...new Set([...(posted||[]).map(r=>r.id), ...(joined||[]).map(r=>r.id)])];
    const countsMap = await getSeatsFilledMap(allIds);

    renderMyRides(posted||[], joined||[], countsMap, email);
    setText("my_msg","Loaded.");
    $("my_refresh_btn").disabled = false;
  }

  function renderMyRides(posted, joined, countsMap, myEmail){
    const container = $("my_rides");
    container.innerHTML = "";

    const sectionTitle = (txt) => {
      const d = document.createElement("div");
      d.className = "muted";
      d.style.fontWeight = "900";
      d.style.marginTop = "8px";
      d.textContent = txt;
      return d;
    };

    const makeCard = (r, tag) => {
      const filled = countsMap[r.id] || 0;
      const isOwner = normEmail(r.owner_email) === myEmail;
      const joinedByMe = true; // because in My Rides
      const canCancel = !isOwner; // don't allow owner to "cancel join" (would remove their own seat)
      const isFull = filled >= r.max_seats;

      const div = document.createElement("div");
      div.className = "ride";

const timeLine = `${formatTimeAMPM(r.from_time)}–${formatTimeAMPM(r.to_time)}`;
const metaLine = `${isoToMDY(r.ride_date)} · ${r.direction} · ${r.airport}`;
const statusText = isFull ? "FULL" : "OPEN";
      
div.innerHTML = `
  <div class="row" style="justify-content:space-between; gap:10px;">
    <div class="row" style="gap:8px;">
      <span class="pill">${escapeHtml(tag)}</span>
      ${isOwner ? `<span class="pill">HOST</span>` : `<span class="pill">RIDER</span>`}
    </div>
    <span class="pill">${statusText}</span>
  </div>

  <div class="rideTime">${escapeHtml(timeLine)}</div>

  <div class="rideMeta">
    <span>${escapeHtml(metaLine)}</span>
  </div>

  <div class="kv">
    <div class="kvRow">
      <div class="kvLabel">Seats</div>
      <div class="kvValue">${filled}/${r.max_seats} filled</div>
    </div>

    <div class="kvRow">
      <div class="kvLabel">Contact</div>
      <div class="kvValue">${escapeHtml(r.contact)}</div>
    </div>
  </div>

  ${canCancel ? `
    <div class="row" style="margin-top:12px;">
      <button class="danger" data-cancel="${r.id}">Cancel Join</button>
    </div>
  ` : `
    <div class="row" style="margin-top:12px;">
      <button class="danger" data-cancel-ride="${r.id}">Cancel Ride</button>
    </div>
    <div class="hint" style="margin-top:10px;">
      Cancelling will hide this ride from everyone.
    </div>
  `}
`;

      return div;
    };

    container.appendChild(sectionTitle("My Posted Rides"));
    if(!posted.length){
      const d = document.createElement("div"); d.className="muted"; d.textContent="(none)"; container.appendChild(d);
    } else {
      posted.forEach(r=>container.appendChild(makeCard(r,"POSTED")));
    }

    container.appendChild(document.createElement("div")).className = "hr";

    container.appendChild(sectionTitle("My Joined Rides"));
    const joinedOnly = joined.filter(r=> !posted.some(p=>p.id===r.id));
    if(!joinedOnly.length){
      const d = document.createElement("div"); d.className="muted"; d.textContent="(none)"; container.appendChild(d);
    } else {
      joinedOnly.forEach(r=>container.appendChild(makeCard(r,"JOINED")));
    }

      container.querySelectorAll("button[data-cancel]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const rideId = btn.getAttribute("data-cancel");
        await cancelJoinClick(rideId, btn);
      });
    });

    container.querySelectorAll("button[data-cancel-ride]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const rideId = btn.getAttribute("data-cancel-ride");
        await cancelRideAsHostClick(rideId, btn);
      });
    });


  }

  // ====== INIT ======
  document.addEventListener("DOMContentLoaded", async ()=>{
      // If user comes back from Supabase recovery email, exchange code for a session
  try{
    const url = new URL(window.location.href);
    if(url.searchParams.get("code")){
      await sb.auth.exchangeCodeForSession(window.location.href);
      // Clean URL (optional)
      url.searchParams.delete("code");
      window.history.replaceState({}, document.title, url.toString());
    }
  }catch(e){
    console.warn("exchangeCodeForSession failed:", e);
  }

    // Tabs
    $("tab_post").addEventListener("click", ()=> activateTab("post"));
    $("tab_find").addEventListener("click", ()=> activateTab("find"));
    $("tab_my").addEventListener("click", ()=> loadMyRidesClick());

    // Buttons
    $("post_btn").addEventListener("click", postRideClick);
    $("find_btn").addEventListener("click", searchRides);
    $("my_refresh_btn").addEventListener("click", loadMyRides);

  // Auth button
$("auth_btn").addEventListener("click", async ()=>{
  await refreshUser();

  if(currentUser?.email){
    $("auth_btn").disabled = true;

    try{
      await sb.auth.signOut();
    }catch(e){
      console.warn("signOut failed:", e);
    }

    currentUser = null;
    setAuthUI();
    resetUIAfterSignOut();

    $("auth_btn").disabled = false;
  }else{
    openSignInModal("");
  }
});


    // Sign-in modal actions
    $("signin_close").addEventListener("click", closeSignInModal);
    $("signin_overlay").addEventListener("click", (e)=>{
      if(e.target === $("signin_overlay")) closeSignInModal();
    });

    $("signup_pw_btn").addEventListener("click", ()=>{
  const email = normEmail($("signin_email").value);
  closeSignInModal();
  openSignUpModal(email);
});


$("signin_pw_btn").addEventListener("click", async ()=>{
  const email = normEmail($("signin_email").value);
  const pw = $("signin_password").value || "";
  const ok = await signInWithPassword(email, pw);
  if(ok){
    await refreshUser();
    if(currentUser?.email) closeSignInModal();
  }
});

    // Sign up modal actions
$("signup_close").addEventListener("click", closeSignUpModal);
$("signup_back_btn").addEventListener("click", ()=>{
  closeSignUpModal();
  openSignInModal($("signup_email").value || "");
});

$("signup_overlay").addEventListener("click", (e)=>{
  if(e.target === $("signup_overlay")) closeSignUpModal();
});

$("signup_create_btn").addEventListener("click", async ()=>{
  setText("signup_msg","");
  setText("signup_err","");

  const email = normEmail($("signup_email").value);
  const p1 = $("signup_password").value || "";
  const p2 = $("signup_password2").value || "";

  if(!email || !isNU(email)){
    setText("signup_err","Please use your Northwestern email (@u.northwestern.edu).");
    return;
  }
  if(p1.length < 8){
    setText("signup_err","Password must be at least 8 characters.");
    return;
  }
  if(p1 !== p2){
    setText("signup_err","Passwords do not match.");
    return;
  }

  // Use your existing signUpWithPassword function
  const ok = await signUpWithPassword(email, p1);
  if(ok){
    setText("signup_msg","Account created. Please check your email if confirmation is required, then sign in.");
    // Optional: go back to sign in modal
    closeSignUpModal();
    openSignInModal(email);
  }
});

// Forgot password + reset password actions
$("forgot_pw_btn").addEventListener("click", async ()=>{
  const email = normEmail($("signin_email").value);
  await sendPasswordRecovery(email);
});

$("reset_save_btn").addEventListener("click", updatePasswordFromRecovery);

$("reset_back_btn").addEventListener("click", ()=>{
  showSignInView();
});

    // Join modal actions
    $("join_close").addEventListener("click", closeJoinModal);
    $("close_join_btn").addEventListener("click", closeJoinModal);
    $("join_overlay").addEventListener("click", (e)=>{
      if(e.target === $("join_overlay")) closeJoinModal();
    });
    $("copy_contact_btn").addEventListener("click", async ()=>{
      const ok = await copyText($("join_contact").value || "");
      $("copy_contact_btn").textContent = ok ? "Copied!" : "Copy failed";
      setTimeout(()=> $("copy_contact_btn").textContent = "Copy contact", 900);
    });
    $("copy_message_btn").addEventListener("click", async ()=>{
      const ok = await copyText($("join_message").value || "");
      $("copy_message_btn").textContent = ok ? "Copied!" : "Copy failed";
      setTimeout(()=> $("copy_message_btn").textContent = "Copy message", 900);
    });
    $("go_my_btn").addEventListener("click", async ()=>{
      closeJoinModal();
      activateTab("my");
      await loadMyRides();
    });

    // Date defaults
    const todayIso = new Date().toISOString().slice(0,10);
    $("find_date").value = todayIso;
    $("post_date").value = todayIso;
    $("find_date_display").textContent = isoToMDY(todayIso);
    $("post_date_display").textContent = isoToMDY(todayIso);

    $("find_date").addEventListener("change", ()=> $("find_date_display").textContent = isoToMDY($("find_date").value));
    $("post_date").addEventListener("change", ()=> $("post_date_display").textContent = isoToMDY($("post_date").value));

    // Time dropdowns
    buildTimeOptions($("post_from"), "14:00", false);
    buildTimeOptions($("post_to"), "15:00", false);
    buildTimeOptions($("find_time"), "", true); // include Anytime

   // Auth state listener
sb.auth.onAuthStateChange(async (event, session)=>{
  await refreshUser();

  if(event === "PASSWORD_RECOVERY"){
    // 用户点了邮箱里的 recover 链接回到网站时会触发
    openSignInModal("");
    showResetView();
    return;
  }

  if(event === "SIGNED_IN"){
    closeSignInModal();
    await maybeResumePendingAction();
  }

  if(event === "SIGNED_OUT"){
    resetUIAfterSignOut();
  }
});



    // Initial auth refresh + resume
    await refreshUser();
    setAuthUI();

    // If user came back from magic link, resume pending action
    await maybeResumePendingAction();
    activateTab("find");

  });
</script>
</body>
</html>
